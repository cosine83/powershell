# Workaround for CVE-2021-36934
# https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-36934

$getACL = icacls c:\windows\system32\config\SAM | Where-Object { $_ -like "*BUILTIN\Users:(I)(RX)" } | Return $true
$fixACL = Get-ChildItem -File -Force $ENV:WINDIR\system32\config | ForEach-Object { icacls $_.FullName /reset }
$prodServQuery = Get-ADComputer -Filter { Enabled -eq $true } -SearchBase "OU=Servers,OU=Organization,DC=prod,DC=domain,DC=com" -Server prod.domain.com
$prodServers = $prodServQuery.Name
$corpServQuery = Get-ADComputer -Filter { Enabled -eq $true } -SearchBase "OU=Servers,OU=Systems,OU=Organization,DC=domain,DC=com" -Server domain.com
$corpServers = $corpServQuery.Name

ForEach ($server in $prodServers) {
    Invoke-Command -ComputerName $server -ScriptBlock {
        If ($using:getACL) {
            $using:fixACL
        } Else {
            Write-Output "$ENV:COMPUTERNAME is not vulnerable to CVE-2021-36934"
        }
    }
}

ForEach ($server in $corpServers) {
    Invoke-Command -ComputerName $server -ScriptBlock {
        If ($using:getACL) {
            $using:fixACL
        } Else {
            Write-Output "$ENV:COMPUTERNAME is not vulnerable to CVE-2021-36934"
        }
    }
}